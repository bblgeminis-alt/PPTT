<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Presupuesto Personal</title>

<!-- Chart.js (solo gr√°fico mini) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Exportaciones -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg:#0f172a;--card:#020617;--text:#e5e7eb;--muted:#94a3b8;
  --green:#22c55e;--blue:#3b82f6;--red:#ef4444;--border:#1e293b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:16px;
}
h1,h3{ text-align:center; margin:10px 0 14px; }

.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  margin:0 auto 16px;
  max-width:980px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
}

input, select, button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
  font-size:16px;
  margin-bottom:10px;
}
input::placeholder{ color:var(--muted); }

button{
  border:none;
  font-weight:700;
  cursor:pointer;
}
.btn-add{ background:var(--green); color:#022c22; }
.btn-exp{ background:var(--blue); color:white; }
.btn-del{ background:var(--red); color:white; }

.table-wrapper{ overflow-x:auto; }

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border:1px solid var(--border);
  text-align:center;
}
th{
  color:var(--muted);
  font-weight:600;
}

.resumen{
  font-size:18px;
  margin-top:8px;
}
.positivo{ color:var(--green); }
.negativo{ color:var(--red); }

/* ===== Tabla detalle (deudas) en m√≥vil: tarjetas con etiquetas ===== */
/* SOLO aplica a .stack (no al cronograma) */
@media(max-width:640px){
  table.stack, table.stack thead, table.stack tbody, table.stack th, table.stack tr{ display:block; }
  table.stack thead{ display:none; }
  table.stack tr{
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    margin-bottom:12px;
    background:#020617;
  }
  table.stack td{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    border:none;
    text-align:right;
  }
  table.stack td::before{
    content:attr(data-label);
    color:var(--muted);
    font-weight:600;
    text-align:left;
    padding-right:10px;
  }
}

/* ===== Cronograma estilo Excel (para ver y exportar) ===== */
.excel-export{
  background:white;
  color:black;
  padding:12px;
  border-radius:12px;
}
.excel-export table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
.excel-export th, .excel-export td{
  border:1px solid #000;
  padding:6px;
  text-align:right;
}
.excel-export th{
  background:#e5e7eb;
  text-align:center;
  font-weight:800;
}

.chart-mini-wrap{
  display:flex;
  justify-content:center;
  align-items:center;
}
#miniPie{
  max-width:260px;
  max-height:260px;
}
.small-note{
  text-align:center;
  color:var(--muted);
  font-size:13px;
  margin-top:6px;
}

.sim-result{
  background:#0b1224;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
}
.sim-result .title{ font-weight:800; margin-bottom:6px; }
.sim-result .ok{ color:var(--green); font-weight:800; }
.sim-result .warn{ color:#fbbf24; font-weight:800; }
.sim-result .bad{ color:var(--red); font-weight:800; }
</style>
</head>

<body>

<h1>üí∞ Presupuesto Personal</h1>

<!-- INGRESO + GRAFICO -->
<div class="card">
  <h3>üíµ Ingreso mensual</h3>
  <input type="number" id="ingreso" placeholder="Ej: 3500000">
  <button class="btn-add" onclick="guardarIngreso()">Guardar ingreso</button>

  <div class="chart-mini-wrap">
    <canvas id="miniPie"></canvas>
  </div>
  <div class="small-note">Ingreso mensual vs suma de cuotas mensuales</div>
</div>

<!-- AGREGAR DEUDA -->
<div class="card">
  <h3>üìå Agregar deuda</h3>
  <input id="nombre" placeholder="Nombre de la deuda">
  <input id="valorPrestamo" type="number" placeholder="Valor del pr√©stamo (capital)">
  <input id="interesFijo" type="number" placeholder="Inter√©s fijo por mes/cuota (ej: 100000)">
  <input id="tiempoMeses" type="number" placeholder="Meses (ej: 5)">
  <button class="btn-add" onclick="agregarDeuda()">Agregar deuda</button>
</div>

<!-- DETALLE DE DEUDAS -->
<div class="card">
  <h3>üìã Detalle de deudas</h3>

  <div class="table-wrapper">
    <table class="stack">
      <thead>
        <tr>
          <th>Deuda</th>
          <th>Pr√©stamo</th>
          <th>Inter√©s fijo</th>
          <th>Meses</th>
          <th>Cuota mensual</th>
          <th>Total a pagar</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="tablaDeudas"></tbody>
    </table>
  </div>

  <p class="resumen">Total cuotas mensuales: $<span id="totalCuotas">0</span></p>
  <p class="resumen">Saldo disponible: $<span id="saldoDisponible">0</span></p>
</div>

<!-- SIMULADOR -->
<div class="card">
  <h3>‚è±Ô∏è Simulador de pago anticipado</h3>

  <select id="selectSimulador">
    <option value="">-- Selecciona una deuda --</option>
  </select>

  <input type="number" id="cuotasPagadas" placeholder="N√∫mero de cuotas pagadas (ej: 2)">
  <input type="number" id="nuevoTiempo" placeholder="Tiempo nuevo (meses) (ej: 2.5)">
  <button class="btn-exp" onclick="simularPagoAnticipado()">Simular</button>

  <div id="resultadoSimulacion" class="sim-result" style="display:none;"></div>
</div>

<!-- CRONOGRAMA -->
<div class="card">
  <h3>üìÜ Cronograma de pagos (inter√©s fijo por cuota)</h3>

  <select id="selectCronograma" onchange="generarCronograma()">
    <option value="">-- Selecciona una deuda --</option>
  </select>

  <!-- Esto se exporta -->
  <div class="table-wrapper excel-export" id="cronogramaExportable">
    <table class="no-stack">
      <thead>
        <tr>
          <th>Mes</th>
          <th>Cuota</th>
          <th>Inter√©s fijo</th>
          <th>Capital</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody id="tablaCuotas"></tbody>
    </table>
  </div>
</div>

<!-- EXPORTAR CRONOGRAMA -->
<div class="card">
  <h3>üì§ Exportar cronograma (deuda seleccionada)</h3>
  <button class="btn-exp" onclick="exportarCronogramaCSV()">Excel (CSV)</button>
  <button class="btn-exp" onclick="exportarCronogramaPDF()">PDF</button>
  <button class="btn-exp" onclick="exportarCronogramaImagen()">Imagen</button>
  <button class="btn-exp" onclick="copiarCronogramaPortapapeles()">Copiar al portapapeles</button>
</div>

<script>
/* =========================
   ESTADO + STORAGE
========================= */
let deudas = JSON.parse(localStorage.getItem("deudas")) || [];
let ingreso = Number(localStorage.getItem("ingreso")) || 0;

let miniPieChart = null;

document.getElementById("ingreso").value = ingreso;
renderizarTodo();

/* =========================
   HELPERS
========================= */
function money(n){
  const v = Number(n);
  if (!Number.isFinite(v)) return "0";
  return v.toLocaleString("es-CO");
}
function toNum(id){
  return Number(document.getElementById(id).value);
}
function byId(id){ return document.getElementById(id); }

/* =========================
   INGRESO
========================= */
function guardarIngreso(){
  ingreso = Number(byId("ingreso").value) || 0;
  localStorage.setItem("ingreso", String(ingreso));
  renderizarTodo();
}

/* =========================
   DEUDAS: AGREGAR / ELIMINAR
   Inter√©s fijo por mes = monto fijo (no %)
   Total = capital + (interesFijo * meses)
   Cuota = Total / meses
========================= */
function agregarDeuda(){
  const nombre = byId("nombre").value.trim();
  const valorPrestamo = Number(byId("valorPrestamo").value);
  const interesFijo = Number(byId("interesFijo").value);
  const meses = Number(byId("tiempoMeses").value);

  if(!nombre || valorPrestamo <= 0 || meses <= 0 || interesFijo < 0){
    alert("Datos inv√°lidos. Revisa nombre, pr√©stamo, inter√©s fijo y meses.");
    return;
  }

  const totalPagar = valorPrestamo + (interesFijo * meses);
  const cuotaMensual = totalPagar / meses;

  deudas.push({
    nombre,
    valorPrestamo,
    interesFijo,      // monto fijo por mes/cuota
    tiempoMeses: meses,
    cuotaMensual,
    totalPagar
  });

  localStorage.setItem("deudas", JSON.stringify(deudas));

  // limpiar campos
  byId("nombre").value = "";
  byId("valorPrestamo").value = "";
  byId("interesFijo").value = "";
  byId("tiempoMeses").value = "";

  renderizarTodo();
}

function eliminarDeuda(index){
  deudas.splice(index, 1);
  localStorage.setItem("deudas", JSON.stringify(deudas));

  // limpiar cronograma si qued√≥ apuntando a una deuda inexistente
  byId("tablaCuotas").innerHTML = "";
  byId("selectCronograma").value = "";
  renderizarTodo();
}

/* =========================
   RENDER: TABLA + SELECTS + RESUMEN + GRAFICO
========================= */
function renderizarTodo(){
  renderTablaDeudas();
  renderSelects();
  renderResumenYGrafico();
  // si hay una deuda seleccionada en cronograma, regenerar
  if (byId("selectCronograma").value !== ""){
    generarCronograma();
  }
}

function renderTablaDeudas(){
  const tbody = byId("tablaDeudas");
  tbody.innerHTML = "";

  deudas.forEach((d, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-label="Deuda">${d.nombre}</td>
      <td data-label="Pr√©stamo">$${money(d.valorPrestamo)}</td>
      <td data-label="Inter√©s fijo">$${money(d.interesFijo)}</td>
      <td data-label="Meses">${d.tiempoMeses}</td>
      <td data-label="Cuota mensual">$${money(d.cuotaMensual)}</td>
      <td data-label="Total a pagar">$${money(d.totalPagar)}</td>
      <td data-label="Acci√≥n">
        <button class="btn-del" onclick="eliminarDeuda(${i})">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function renderSelects(){
  const selSim = byId("selectSimulador");
  const selCro = byId("selectCronograma");

  const prevSim = selSim.value;
  const prevCro = selCro.value;

  selSim.innerHTML = `<option value="">-- Selecciona una deuda --</option>`;
  selCro.innerHTML = `<option value="">-- Selecciona una deuda --</option>`;

  deudas.forEach((d, i) => {
    const o1 = document.createElement("option");
    o1.value = String(i);
    o1.textContent = d.nombre;
    selSim.appendChild(o1);

    const o2 = document.createElement("option");
    o2.value = String(i);
    o2.textContent = d.nombre;
    selCro.appendChild(o2);
  });

  // intentar mantener selecciones
  if (prevSim !== "") selSim.value = prevSim;
  if (prevCro !== "") selCro.value = prevCro;
}

function renderResumenYGrafico(){
  const totalCuotas = deudas.reduce((acc, d) => acc + (Number(d.cuotaMensual) || 0), 0);
  byId("totalCuotas").innerText = money(totalCuotas);

  const saldo = (Number(ingreso) || 0) - totalCuotas;
  const saldoEl = byId("saldoDisponible");
  saldoEl.innerText = money(saldo);
  saldoEl.className = saldo < 0 ? "negativo" : "positivo";

  renderMiniPie(ingreso, totalCuotas);
}

function renderMiniPie(ingresoMensual, cuotasMensuales){
  const ingresoVal = Math.max(Number(ingresoMensual) || 0, 0);
  const cuotasVal = Math.max(Number(cuotasMensuales) || 0, 0);
  const saldo = Math.max(ingresoVal - cuotasVal, 0);

  if (miniPieChart) miniPieChart.destroy();

  miniPieChart = new Chart(byId("miniPie"), {
    type: "doughnut",
    data: {
      labels: ["Cuotas mensuales", "Saldo libre"],
      datasets: [{
        data: [cuotasVal, saldo],
        backgroundColor: ["#ef4444", "#22c55e"]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: "bottom",
          labels: { color: "#e5e7eb", boxWidth: 12 }
        }
      },
      cutout: "60%"
    }
  });
}

/* =========================
   CRONOGRAMA (inter√©s fijo por cuota)
   interes fijo = d.interesFijo (monto constante por mes)
   capital = cuota - interesFijo
   saldo baja por capital
========================= */
function generarCronograma(){
  const idx = byId("selectCronograma").value;
  const tbody = byId("tablaCuotas");
  tbody.innerHTML = "";

  if (idx === "") return;

  const d = deudas[Number(idx)];
  if (!d) return;

  let saldo = d.valorPrestamo;
  const interesFijo = d.interesFijo;
  const cuota = d.cuotaMensual;

  for (let mes = 1; mes <= d.tiempoMeses; mes++){
    const interes = interesFijo;                 // fijo (NO se divide)
    const capital = cuota - interes;             // parte que reduce saldo
    saldo = Math.max(saldo - capital, 0);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:center;">${mes}</td>
      <td>${Math.round(cuota)}</td>
      <td>${Math.round(interes)}</td>
      <td>${Math.round(capital)}</td>
      <td>${Math.round(saldo)}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* =========================
   SIMULADOR (solo cambian campos pedidos)
   - Mantener:
     Tiempo original
     Tiempo nuevo
     Ahorro aproximado
   - Cambios:
     "Nueva cuota aprox" -> Total cuotas pagadas
     "Nuevo total a pagar" -> Total a pagar cr√©dito
     Nuevo: Nuevo saldo a pagar = Total a pagar cr√©dito - Total cuotas pagadas
   - Cuotas pagadas input requerido
   - Inter√©s fijo por mes
   - Total original = capital + interesFijo * mesesOriginal
   - Total cr√©dito con tiempo nuevo = capital + interesFijo * nuevoTiempo
========================= */
function simularPagoAnticipado(){
  const idx = byId("selectSimulador").value;
  const cuotasPagadas = Number(byId("cuotasPagadas").value);
  const nuevoTiempo = Number(byId("nuevoTiempo").value);

  if (idx === "") { alert("Selecciona una deuda."); return; }
  if (!Number.isFinite(cuotasPagadas) || cuotasPagadas < 0) { alert("Ingresa un n√∫mero v√°lido de cuotas pagadas."); return; }
  if (!Number.isFinite(nuevoTiempo) || nuevoTiempo <= 0) { alert("Ingresa un tiempo nuevo v√°lido (meses)."); return; }

  const d = deudas[Number(idx)];
  if (!d) { alert("Deuda no encontrada."); return; }

  const tiempoOriginal = d.tiempoMeses;
  const totalOriginal = d.totalPagar; // ya calculado: capital + interesFijo*tiempoOriginal

  const totalCuotasPagadas = d.cuotaMensual * cuotasPagadas;

  // Total a pagar cr√©dito con inter√©s fijo por mes (lineal)
  const totalPagarCredito = d.valorPrestamo + (d.interesFijo * nuevoTiempo);

  // Nuevo saldo (resta de total cr√©dito - cuotas pagadas)
  const nuevoSaldo = totalPagarCredito - totalCuotasPagadas;

  // Ahorro aproximado (como antes): totalOriginal - totalPagarCredito
  const ahorro = totalOriginal - totalPagarCredito;

  const box = byId("resultadoSimulacion");
  box.style.display = "block";

  const saldoClass =
    nuevoSaldo > 0 ? "warn" :
    nuevoSaldo < 0 ? "ok" : "ok";

  const saldoTexto =
    nuevoSaldo > 0 ? `Nuevo saldo a pagar: $${money(nuevoSaldo)}` :
    nuevoSaldo < 0 ? `Nuevo saldo a pagar: $0 (pagaste de m√°s: $${money(Math.abs(nuevoSaldo))})` :
    `Nuevo saldo a pagar: $0`;

  box.innerHTML = `
    <div class="title">${d.nombre}</div>
    Tiempo original: ${tiempoOriginal} meses<br>
    Tiempo nuevo: ${nuevoTiempo} meses<br><br>

    <strong>Total cuotas pagadas:</strong> $${money(totalCuotasPagadas)}<br>
    <strong>Total a pagar cr√©dito:</strong> $${money(totalPagarCredito)}<br>
    <strong class="${saldoClass}">${saldoTexto}</strong><br><br>

    <strong>Ahorro aproximado:</strong> $${money(ahorro)}
  `;
}

/* =========================
   EXPORTACIONES (solo cronograma)
========================= */
function getDeudaCronograma(){
  const idx = byId("selectCronograma").value;
  if (idx === "") return null;
  return deudas[Number(idx)] || null;
}

function exportarCronogramaCSV(){
  const d = getDeudaCronograma();
  if (!d) { alert("Selecciona una deuda para exportar el cronograma."); return; }

  let saldo = d.valorPrestamo;
  const interes = d.interesFijo;
  const cuota = d.cuotaMensual;

  let csv = "Mes,Cuota,Inter√©s fijo,Capital,Saldo\n";
  for (let mes = 1; mes <= d.tiempoMeses; mes++){
    const capital = cuota - interes;
    saldo = Math.max(saldo - capital, 0);
    csv += `${mes},${Math.round(cuota)},${Math.round(interes)},${Math.round(capital)},${Math.round(saldo)}\n`;
  }

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `cronograma_${d.nombre}.csv`;
  a.click();
}

function exportarCronogramaPDF(){
  const d = getDeudaCronograma();
  if (!d) { alert("Selecciona una deuda para exportar el cronograma."); return; }

  html2pdf()
    .from(byId("cronogramaExportable"))
    .set({
      margin: 0.4,
      filename: `cronograma_${d.nombre}.pdf`,
      html2canvas: { scale: 2 }
    })
    .save();
}

function exportarCronogramaImagen(){
  const d = getDeudaCronograma();
  if (!d) { alert("Selecciona una deuda para exportar el cronograma."); return; }

  html2canvas(byId("cronogramaExportable")).then(canvas=>{
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = `cronograma_${d.nombre}.png`;
    a.click();
  });
}

function copiarCronogramaPortapapeles(){
  const d = getDeudaCronograma();
  if (!d) { alert("Selecciona una deuda para copiar el cronograma."); return; }

  let saldo = d.valorPrestamo;
  const interes = d.interesFijo;
  const cuota = d.cuotaMensual;

  let texto = `Cronograma - ${d.nombre}\n`;
  texto += `Capital: ${d.valorPrestamo} | Inter√©s fijo: ${d.interesFijo} | Meses: ${d.tiempoMeses}\n\n`;
  texto += `Mes | Cuota | Inter√©s | Capital | Saldo\n`;

  for (let mes = 1; mes <= d.tiempoMeses; mes++){
    const capital = cuota - interes;
    saldo = Math.max(saldo - capital, 0);
    texto += `${mes} | ${Math.round(cuota)} | ${Math.round(interes)} | ${Math.round(capital)} | ${Math.round(saldo)}\n`;
  }

  navigator.clipboard.writeText(texto)
    .then(()=>alert("Cronograma copiado ‚úÖ"))
    .catch(()=>alert("No se pudo copiar. Revisa permisos del navegador."));
}
</script>

</body>
</html>
